!function(a){a.fn.snapPuzzle=function(b){function d(b){var d="sp_"+(new Date).getTime(),f=b.wrap('<span class="snappuzzle-wrap"/>').closest("span"),g=b.attr("src"),h=b.width()/c.columns,i=b.height()/c.rows,j=a(c.pile).addClass("snappuzzle-pile"),k=j.width()-h,l=j.height()-i,m=[];c.puzzle_class=d,b.data("options",c),num=1;for(var n=0;n<c.rows;n++)for(var o=0;o<c.columns;o++)m.push([n,o,num]),num++;m=e(m),m.forEach(function(e){var m=e[0],n=e[1],o=e[2];a('<div class="snappuzzle-piece '+d+'" data-number="'+(100*o).toString(36)+'"/>').data("pos",m+"_"+n).css({width:h,height:i,position:"absolute",left:Math.floor(Math.random()*(k+1)),top:Math.floor(Math.random()*(l+1)),zIndex:Math.floor(10*Math.random()+1),backgroundImage:"url("+g+")",backgroundPosition:-n*h+"px "+-m*i+"px",backgroundSize:b.width()}).draggable({start:function(d,e){a(this).removeData("slot"),c.onDraggable(b)},stack:".snappuzzle-piece",containment:c.containment}).appendTo(j).data("lastSlot",j),a('<div class="snappuzzle-slot '+d+'"/>').data("pos",m+"_"+n).css({width:h,height:i,left:n*h,top:m*i}).appendTo(f).droppable({accept:"."+d,hoverClass:"snappuzzle-slot-hover",drop:function(e,f){var g=a(this).data("pos");return a(".snappuzzle-piece."+d).each(function(){a(this).data("slot")==g&&(g=!1)}),!!g&&(f.draggable.data("lastSlot",a(this)).data("slot",g),f.draggable.position({of:a(this),my:"left top",at:"left top"}),void(f.draggable.data("pos")==g&&(f.draggable.addClass("correct"),c.onCorrect(f.draggable),a(this).droppable("disable").css("opacity",1),f.draggable.css({opacity:0,cursor:"default"}).draggable("disable"),a(".snappuzzle-piece.correct."+d).length==c.rows*c.columns&&c.onComplete(b))))}})})}function e(a){for(var b,c,d=a.length;d;b=parseInt(Math.random()*d),c=a[--d],a[d]=a[b],a[b]=c);return a}var c=a.extend({pile:"",containment:"document",rows:5,columns:5,onComplete:function(){},onCorrect:function(a){},onDraggable:function(){}},b);return"string"==typeof b?(this.each(function(){var c=a(this),d=c.data("options"),e=c.width()/d.columns,f=c.height()/d.rows,g=a(d.pile),h=g.width()-e,i=g.height()-f,j=c.closest("span").offset(),k=g.offset();"destroy"==b?(a("."+d.puzzle_class).remove(),c.unwrap().removeData("options"),g.removeClass("snappuzzle-pile")):"refresh"==b&&(a(".snappuzzle-slot."+d.puzzle_class).each(function(){var b=a(this).data("pos").split("_"),c=b[0],d=b[1];a(this).css({width:e,height:f,left:d*e,top:c*f})}),a(".snappuzzle-piece."+d.puzzle_class).each(function(){if(a(this).data("slot")){var b=a(this).data("slot").split("_"),d=b[0],g=b[1],b=a(this).data("pos").split("_"),l=b[0],m=b[1];a(this).css({width:e,height:f,left:g*e+j.left-k.left,top:d*f+j.top-k.top,backgroundPosition:-m*e+"px "+-l*f+"px",backgroundSize:c.width()})}else{var b=a(this).data("pos").split("_"),n=b[0],o=b[1];a(this).css({width:e,height:f,left:Math.floor(Math.random()*(h+1)),top:Math.floor(Math.random()*(i+1)),backgroundPosition:-o*e+"px "+-n*f+"px",backgroundSize:c.width()})}}))}),this):this.each(function(){this.complete?d(a(this)):a(this).load(function(){d(a(this))})})}}(jq_jQuery);